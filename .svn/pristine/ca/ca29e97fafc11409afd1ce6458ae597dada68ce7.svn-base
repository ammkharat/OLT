
IF EXISTS (SELECT * FROM sysobjects WHERE type = 'P' AND name = 'QueryOpmExcursionResponseDTOByDateRangeAndFlocNames')
	BEGIN
		DROP Procedure [dbo].QueryOpmExcursionResponseDTOByDateRangeAndFlocNames
	END
GO

CREATE Procedure [dbo].QueryOpmExcursionResponseDTOByDateRangeAndFlocNames
    (
		@CsvFlocIds varchar(MAX),
		@StartOfDateRange DateTime,
		@EndOfDateRange DateTime
    )
AS
select 
	ex.Id,
	ex.OpmExcursionId,
	ex.ToeName,
	ex.ToeType,
	ex.FunctionalLocation,
	ex.Status,
	ex.StartDateTime,
	ex.EndDateTime,
	ex.UnitOfMeasure,
	ex.Peak,
	ex.Average,
	ex.Duration,
	ex.ToeLimitValue,
	ex.IlpNumber,
	ex.EngineerComments,
	ex.ReasonCode,
	er.Response,
	er.LastModifiedByUserId,
	er.LastModifiedDateTime
from 
	OpmExcursion ex
	INNER JOIN FunctionalLocation fl ON ex.FunctionalLocationId = fl.Id
	 left outer join OpmExcursionResponse er on ex.Id = er.OltExcursionId
where 
	((ex.StartDateTime <= @EndOfDateRange 
	AND
    ex.StartDateTime >= @StartOfDateRange)
    OR
    (ex.StartDateTime <= @EndOfDateRange 
	AND
    ex.EndDateTime >= @StartOfDateRange)
    OR
    (ex.StartDateTime <= @EndOfDateRange
AND
   ex.Status =1))
    
AND
	(
    EXISTS
    (
      SELECT ids.Id
      FROM 
		IDSplitter(@CsvFlocIds) ids
      WHERE 
		ids.Id = fl.Id
    )
    OR
    EXISTS
    (
  		SELECT ids.Id
	  	FROM 
			IDSplitter(@CsvFlocIds) ids 
			INNER JOIN FunctionalLocationAncestor a ON a.Id = ids.Id
		WHERE 
			a.AncestorId = fl.Id
	  )   
    OR
    EXISTS
    (
  		SELECT ids.Id
	  	FROM 
			IDSplitter(@CsvFlocIds) ids 
			INNER JOIN FunctionalLocationAncestor fla ON fla.AncestorId = ids.Id
		WHERE 
			fla.Id = fl.Id
	  )
  )
OPTION (OPTIMIZE FOR UNKNOWN)  
GO